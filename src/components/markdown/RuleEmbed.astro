---
import type { RuleFields } from "@/content/config";
import { getCollection, getEntry } from "astro:content";

interface Props {
  rule?: string;;
  ruleId?: number;
  fields?: RuleFields[] | "All";
}

const { rule: ruleName, ruleId, fields = [] } = Astro.props;

let ruleEntry;

const getIsoDate = (date: Date): string => {
  return date.toISOString().split("T")[0];
};

if (ruleName) {
  ruleEntry = await getEntry("rules", ruleName);
} else if (ruleId !== undefined) {
  // Filter by numeric ID
  const ruleEntries = await getCollection("rules", (entry: { data: { id: number; }; }) => {
    return entry.data.id === ruleId;
  });
  ruleEntry = ruleEntries[0];
} else {
  throw new Error("Either 'rule' (string) or 'ruleId' (number) must be provided");
}

if (!ruleEntry) {
  const identifier = ruleName ? `"${ruleName}"` : `ID ${ruleId}`;
  throw new Error(`Rule ${identifier} not found`);
}

const ruleData = ruleEntry.data;
const content = await ruleEntry.render();

/* Skipped fields:
- name (always displayed)
- id (always displayed)
- status (always displayed if Deprecated)
- detection_script
- be_validations
*/

const shouldShowField = (fieldName: RuleFields): boolean => {
  return fields === "All" || fields.includes(fieldName);
};

const shouldShowGroup = (groupFields: RuleFields[]): boolean => {
  return fields === "All" || groupFields.some((field) => fields.includes(field));
};
---

<div class="rule-embed">
  <div class="border-b mt-0">
    <h3 class="m-0 text-base flex">
      <span class="border-r px-2 py-1 block">
        Rule {ruleData.id}<span class="w-0 collapse inline-block">:{` `}</span>
      </span>
      <span class="px-2 py-1 block">
        <a href={`/rules/${ruleEntry.slug}`}> {ruleData.name}</a>
      </span>
    </h3>
  </div>

  <div class="px-4">
    {content && <content.Content />}

    {ruleData.rationale && <p>Rationale: {ruleData.rationale}</p>}

    {ruleData.status == "Deprecated" && <p class="text-red-500">⚠️ This rule has been deprecated {ruleData.date_modified && `(${getIsoDate(ruleData.date_modified)})`}</p>}

    {
      shouldShowGroup(["entry_status", "entry_type"]) && (
        <p>
          (Applies to all
          {<em>{ruleData.entry_status !== "Draft" && ruleData.entry_status.toLowerCase()}</em>} {ruleData.entry_type !== "All" && ruleData.entry_type.map((str: string) => str.toLowerCase().replace(/s$/, "")).join(" & ")}
          entries)
        </p>
      )
    }

    {
      shouldShowGroup(["date_created", "date_modified"]) && (
        <>
          {ruleData.date_created && <p>Rule created {getIsoDate(ruleData.date_created)}</p>}
          {ruleData.date_modified && <p>Rule modified {getIsoDate(ruleData.date_modified)}</p>}
        </>
      )
    }

    {
      shouldShowField("fe_validations") && ruleData.fe_validations && (
        <p>
          Frontend validation with: <a href={`https://github.com/search?type=code&q=repo%3AVocaDB%2Fvocadb+Validation+${ruleData.fe_validations}`}>{ruleData.fe_validations}</a>
        </p>
      )
    }

    {
      shouldShowGroup(["occurance", "edit_list", "date_checked"]) && (ruleData.occurance ?? 0) > 0 && (
        <p>
          {`~${ruleData.occurance} affected entries`}
          {ruleData.edit_list && (
            <span>
              : <a href={ruleData.edit_list}>Edit list</a>
              {ruleData.date_checked && ` updated ${getIsoDate(ruleData.date_checked)}`}
            </span>
          )}
        </p>
      )
    }
  </div>
</div>
