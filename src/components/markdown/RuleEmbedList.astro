---
import RuleEmbed from "@/components/markdown/RuleEmbed.astro";
import { EntryType, type RuleFields } from "@/content/config";
import { getCollection, type CollectionEntry } from "astro:content";
import { BoxGroup } from "@/components/Box.tsx";

let rules: CollectionEntry<"rules">[] = await getCollection("rules");

interface Props {
  entryType: (typeof EntryType)[number] | "All";
  ruleContext?: string;
  fields?: RuleFields[] | "All";
  excludedIds: number[];
}

const { entryType, ruleContext, fields, excludedIds } = Astro.props;

if (excludedIds) {
  rules = rules.filter(rule => !excludedIds.includes(rule.data.id));
}
if (entryType !== "All") {
  rules = rules.filter(rule => {
    const ruleEntryType = rule.data.entry_type;

    if (ruleEntryType === "All") {
      return true;
    }

    if (Array.isArray(ruleEntryType)) {
      return ruleEntryType.includes(entryType);
    }

    return false;
  });
}

if (ruleContext) {
  rules = rules.filter(rule => rule.data.rule_context === ruleContext);
}

rules.sort((a, b) => a.data.id - b.data.id);
---

<BoxGroup>
{
  rules.map((rule) => (
    <RuleEmbed
      rule={rule}
      fields={fields}
    />
  ))
}
</BoxGroup>