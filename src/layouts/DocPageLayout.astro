---
import type { MarkdownHeading } from "astro";
import Layout from "./Base.astro";
import { TagsDisplay } from "@/components/TagsDisplay";
import { ScrollArea } from "@/components/ui/scroll-area";
import { generateToC } from "@/utils/generateToC.ts";
import TableOfContentsList from "@/components/TableOfContentsList.astro"
import { CounterClockwiseClockIcon, ExclamationTriangleIcon, Pencil1Icon } from "@radix-ui/react-icons";
import { cn } from "@/lib/utils.ts";

export interface Props {
  headings?: MarkdownHeading[];
  frontmatter?: any;
  title?: string;
  description?: string;
  filePath?: string;
  noRightSidebar?: boolean;
}

const { frontmatter = {}, headings, filePath, noRightSidebar } = Astro.props;

let toc = null;

if (headings && headings.length > 0)
  toc = generateToC(headings, {
    minHeadingLevel: 2,
    maxHeadingLevel: 4
  })

const title = Astro.props?.title ?? frontmatter?.title;
const description = Astro.props?.description ?? frontmatter?.description;
---

<Layout title={title} description={description}>
  <main class="relative xl:grid xl:grid-cols-[1fr_300px] gap-10">
    <article data-pagefind-body class={cn("prose dark:prose-invert max-w-none min-w-0", noRightSidebar && "col-span-2")}>
      <header class="mb-8">
        <h1 class="mb-8">{title}</h1>
        <TagsDisplay tags={frontmatter.tags ?? []} />
        {
          toc && (
            <details class="not-prose xl:hidden rounded-xl border shadow mb-4 bg-card">
              <summary class="font-semibold tracking-tight m-2 mx-4 cursor-pointer">On this page</summary>
              <div class="my-2">
                <TableOfContentsList isMobile={true} toc={toc} />
              </div>
            </details>
          )
        }
      </header>
      <slot />
      <hr class="mb-4"/>
      <footer class="not-prose">
        <p>
          
          { [
            filePath && ['https://github.com/VocaDB/Wiki/edit/main/' + filePath, <><Pencil1Icon  className="inline align-[-0.125em]" /> Edit this page</>],
            filePath && ['https://github.com/VocaDB/Wiki/commits/main/' + filePath, <><CounterClockwiseClockIcon className="inline align-[-0.125em]" /> See page history</>],
            ['https://github.com/VocaDB/Wiki/issues/new', <><ExclamationTriangleIcon className="inline align-[-0.125em]" /> Report an issue</>],
          ].filter(e => e).flatMap(e => [<a href={ e[0] } class="hover:underline" target="_blank">{ e[1] }</a>, ' â€¢ ']).slice(0, -1) }
      </footer>
    </article>

    { !noRightSidebar && <div class="hidden xl:block text-sm sticky top-16 h-[calc(100vh-4rem)] -my-6">
      <ScrollArea className="h-full" client:visible>
        <div class="py-6">
          {toc && <div>
              <p class="font-semibold mb-2">On this page</p>
              <TableOfContentsList track={true} toc={toc} />
          </div>}
        </div>
      </ScrollArea>
    </div> }
  </main>
</Layout>
