---
import RuleEmbed from "@/components/markdown/RuleEmbed.astro";
import { FormattedField } from "@/components/markdown/RuleFormattedField.tsx";
import { getCollection } from "astro:content";
import DocPageLayout from "../../layouts/DocPageLayout.astro";
import { unified } from 'unified';
import remarkParse from 'remark-parse';
import stripMarkdown from 'strip-markdown';
import remarkStringify from 'remark-stringify';
import { ruleDataKeyDetailsDictionary, ruleDataKeyDictionary } from "@/content/config.ts";

export async function getStaticPaths() {
  const ruleEntries = await getCollection("rules");
  const paths = [];
  
  for (const entry of ruleEntries) {
    const pathConfig = {
      params: {
        slug: entry.slug
      },
      props: { entry }
    };
    
    paths.push(pathConfig);
    
    if (typeof entry.data.id === 'number') {
      paths.push({
        params: {
          slug: entry.data.id.toString()
        },
        props: { entry }
      });
    }
  }
  
  return paths;
}

const { entry } = Astro.props;
const { headings } = await entry.render();

headings.push({ depth: 2, slug: 'metadata', text: 'Metadata' })

const isNumericRoute = !isNaN(Number(Astro.params.slug));

const a = FormattedField

async function stripText(markdownInput: string) {
  const file = await unified()
    .use(remarkParse)
    .use(stripMarkdown)
    .use(remarkStringify)
    .process(markdownInput);

  return String(file);
}

let content
if (entry.data.excerpt) {
  content = await entry.render()
} 
const description = await stripText(entry.data.excerpt || entry.body)
---

<DocPageLayout
  frontmatter={entry.data}
  title={`Rule: ${entry.data.name}`}
  description={description}
  headings={headings},
  filePath={'src/content/rules/' + entry.id}
  pagefindIgnore={isNumericRoute}>
  
  <script define:vars={{ slug: entry.slug, currentPath: Astro.params.slug }} is:inline>
    // Redirect to canonical URL if accessed via numeric ID
    if (currentPath !== slug && !isNaN(Number(currentPath))) {
      const newUrl = window.location.pathname.replace(/\/[^\/]+$/, `/${slug}`);
      window.history.replaceState({}, '', newUrl);
    }
  </script>
  
  <RuleEmbed
    rule={entry}
    fields={"All"}
  />

  {content && <content.Content />}

  <section id="metadata">
    <h2>Metadata</h2>

    <table class="metadata-table">
      <tbody>
        {
          Object.entries(entry.data).map(([fieldKey, fieldValue]) => {
            if (['excerpt'].includes(fieldKey)) return
            return <tr>
              <th class="field-name" title={ruleDataKeyDetailsDictionary[fieldKey]}>{ruleDataKeyDictionary[fieldKey] || fieldKey}:</th>
              <td class="field-value">
                <FormattedField fKey={fieldKey} value={fieldValue} />
              </td>
            </tr>
          })
        }
      </tbody>
    </table>
  </section>
</DocPageLayout>