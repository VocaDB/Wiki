---
import RuleEmbed from "@/components/markdown/RuleEmbed.astro";
import { getCollection } from "astro:content";
import DocPageLayout from "../../layouts/DocPageLayout.astro";
import { unified } from 'unified';
import remarkParse from 'remark-parse';
import stripMarkdown from 'strip-markdown';
import remarkStringify from 'remark-stringify';

export async function getStaticPaths() {
  const ruleEntries = await getCollection("rules");
  const paths = [];
  
  for (const entry of ruleEntries) {
    const pathConfig = {
      params: {
        slug: entry.slug
      },
      props: { entry }
    };
    
    paths.push(pathConfig);
    
    if (typeof entry.data.id === 'number') {
      paths.push({
        params: {
          slug: entry.data.id.toString()
        },
        props: { entry }
      });
    }
  }
  
  return paths;
}

const { entry } = Astro.props;
const { headings } = await entry.render();

const isNumericRoute = !isNaN(Number(Astro.params.slug));

function formatFieldValue(value: any): string {
  if (value === null || value === undefined) {
    return "-";
  }

  if (Array.isArray(value)) {
    return value.join(", ");
  }

  if (value instanceof Date) {
    return value.toLocaleDateString();
  }

  if (typeof value === "boolean") {
    return value ? "True" : "False";
  }

  return String(value);
}

async function stripText(markdownInput: string) {
  const file = await unified()
    .use(remarkParse)
    .use(stripMarkdown)
    .use(remarkStringify)
    .process(markdownInput);

  return String(file);
}

let description = await stripText(entry.body)
---

<DocPageLayout
  frontmatter={entry.data}
  title={`Rule: ${entry.data.name}`}
  description={description}
  headings={headings},
  filePath={'src/content/rules/' + entry.id}>
  <script define:vars={{ slug: entry.slug, currentPath: Astro.params.slug }} is:inline>
    // Redirect to canonical URL if accessed via numeric ID
    if (currentPath !== slug && !isNaN(Number(currentPath))) {
      const newUrl = window.location.pathname.replace(/\/[^\/]+$/, `/${slug}`);
      window.history.replaceState({}, '', newUrl);
    }
  </script>
  
  <div data-pagefind-ignore={isNumericRoute ? "all" : undefined}>
  <div class="rule-metadata">
    <RuleEmbed
      rule={entry}
      fields={"All"}
    />

    <table class="metadata-table">
      <tbody>
        {
          Object.entries(entry.data).map(([fieldKey, fieldValue]) => (
            <tr>
              <th class="field-name">Rule {fieldKey}:</th>
              <td class="field-value">
                {formatFieldValue(fieldValue)}
              </td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </div>
</DocPageLayout>